
from GPT_stories import getStoryByRole
import discord
from discord.ext import commands
from discord import app_commands
from utils.gpt import generate_gpt_response
from utils.users import UNBUTTERED_BAGEL_ID

async def define_ask_bread_command(tree, servers):
    @tree.command(name="askbread", description="Responds with a custom message generated by OpenAI, incorporating humor related to banana bread.", guilds=servers)
    async def askbread(interaction: discord.Interaction, user_input: str, role: str):
        await interaction.response.defer()

        story = getStoryByRole(role, interaction.user.id)
        # if interaction.user.id == UNBUTTERED_BAGEL_ID:
        #     model = "gpt-4-turbo"  # Way to expensive
        # else:
        model = "gpt-3.5-turbo"
        # Generate the completion response using the selected story
        response_message = await generate_gpt_response(model, story, user_input)
        if len(response_message) > 1999:
            chunks = [response_message[i:i + 1900] for i in range(0, len(response_message), 1800)]
            for i, chunk in enumerate(chunks):
                if i == 0:
                    last_message = await interaction.followup.send(chunk)
                else:
                    last_message = await interaction.followup.send(f"{interaction.user.mention}\n{chunk}")
        else:
            last_message = await interaction.followup.send(response_message)
            return
        await last_message.reply("All parts of the message have been sent!")